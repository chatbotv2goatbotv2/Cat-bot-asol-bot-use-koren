const fs = require("fs");
const { downloadVideo } = require("sagor-video-downloader");

module.exports = {
    config: {
        name: "autolink",
        version: "1.1",
        author: "Akash x helal",
        countDown: 5,
        role: 0,
        shortDescription: "Auto-download & send videos with title (Improved)",
        category: "media",
    },

    onStart: async function () {},

    onChat: async function ({ api, event }) {
        const threadID = event.threadID;
        const messageID = event.messageID;
        const message = event.body || "";

        // à¦²à¦¿à¦™à§à¦• à¦–à§à¦à¦œà§‡ à¦¬à§‡à¦° à¦•à¦°à¦¾ (à¦à¦•à¦¾à¦§à¦¿à¦•)
        const linkMatches = message.match(/(https?:\/\/[^\s]+)/g);
        if (!linkMatches || linkMatches.length === 0) return;

        // à¦¡à§à¦ªà§à¦²à¦¿à¦•à§‡à¦Ÿ à¦°à¦¿à¦®à§à¦­
        const uniqueLinks = [...new Set(linkMatches)];

        // à¦°à¦¿à¦…à§à¦¯à¦¾à¦•à§à¦Ÿ: à¦ªà§à¦°à¦¸à§‡à¦¸à¦¿à¦‚ à¦¶à§à¦°à§
        api.setMessageReaction("â³", messageID, () => {}, true);

        let successCount = 0;
        let failCount = 0;

        for (const url of uniqueLinks) {
            try {
                // à¦²à§‹à¦¡à¦¿à¦‚ à¦®à§‡à¦¸à§‡à¦œ (à¦¬à¦¡à¦¼ à¦­à¦¿à¦¡à¦¿à¦“à¦° à¦œà¦¨à§à¦¯)
                const loadingMsg = await api.sendMessage(
                    `â³downloading`,
                    threadID
                );

                const { title, filePath } = await downloadVideo(url);
                if (!filePath || !fs.existsSync(filePath)) {
                    throw new Error("à¦«à¦¾à¦‡à¦² à¦¡à¦¾à¦‰à¦¨à¦²à§‹à¦¡ à¦¹à¦¯à¦¼à¦¨à¦¿");
                }

                // à¦«à¦¾à¦‡à¦² à¦¸à¦¾à¦‡à¦œ à¦šà§‡à¦• (25MB = 25 * 1024 * 1024 bytes)
                const stats = fs.statSync(filePath);
                const fileSizeInMB = stats.size / (1024 * 1024);

                if (fileSizeInMB > 25) {
                    api.unsendMessage(loadingMsg.messageID);
                    api.sendMessage(
                        `âŒ Video is too big (${fileSizeInMB.toFixed(1)} MB)\nğŸ”— ${url}`,
                        threadID
                    );
                    fs.unlinkSync(filePath);
                    failCount++;
                    continue;
                }

                // à¦¸à¦«à¦² à¦¹à¦²à§‡ à¦ªà¦¾à¦ à¦¾à¦¨à§‹
                await api.sendMessage(
                    {
                        body: `ğŸ¬ *${title || "à¦­à¦¿à¦¡à¦¿à¦“"}*`,
                        attachment: fs.createReadStream(filePath)
                    },
                    threadID,
                    () => {
                        fs.unlinkSync(filePath); // à¦«à¦¾à¦‡à¦² à¦®à§à¦›à§‡ à¦«à§‡à¦²à¦¾
                    }
                );

                // à¦²à§‹à¦¡à¦¿à¦‚ à¦®à§‡à¦¸à§‡à¦œ à¦®à§à¦›à§‡ à¦«à§‡à¦²à¦¾
                api.unsendMessage(loadingMsg.messageID);
                successCount++;

            } catch (err) {
                failCount++;
                api.unsendMessage(loadingMsg?.messageID || "");
                api.sendMessage(
                    `âŒ Failed to download video: ${err.message || "à¦…à¦œà¦¾à¦¨à¦¾ à¦¤à§à¦°à§à¦Ÿà¦¿"}\nğŸ”— ${url.substring(0, 50)}...`,
                    threadID
                );
            }
        }

        // à¦«à¦¾à¦‡à¦¨à¦¾à¦² à¦°à¦¿à¦…à§à¦¯à¦¾à¦•à§à¦Ÿ
        const finalReaction = successCount > 0 && failCount === 0 ? "âœ…" :
                              successCount > 0 ? "âš ï¸" : "âŒ";

        api.setMessageReaction(finalReaction, messageID, () => {}, true);

        // à¦¸à¦¾à¦°à¦¾à¦‚à¦¶ à¦®à§‡à¦¸à§‡à¦œ (à¦à¦šà§à¦›à¦¿à¦•)
        if (uniqueLinks.length > 1) {
            setTimeout(() => {
                api.sendMessage(
                    `ğŸ“Š à¦¸à¦¾à¦°à¦¾à¦‚à¦¶: âœ… ${successCount} success. âŒ ${failCount} failed`,
                    threadID
                );
            }, 2000);
        }
    }
};